## 时序数据的基本概念

### 时序数据的定义

`时间序列数据（Time Series Data，TSD）`：从定义上来说，就是一串按时间维度索引的数据。简单的说，就是这类数据描述了某个被测量的主体在一个时间范围内的每个时间点上的测量值。时序数据普遍存在于 IT 基础设施、运维监控系统和物联网中。

对时序数据进行建模的话，会包含三个重要部分，分别是：`主体，时间点和测量值`。套用这套模型，你会发现你在日常工作生活中，无时无刻不在接触着这类数据：

- 如果你是一个股民，某只股票的股价就是一类时序数据，其记录着每个时间点该股票的股价。

- 如果你是一个运维人员，监控数据就是一类时序数据，例如对于机器的 CPU 的监控数据，就是记录着每个时间点机器上 CPU 的实际消耗值。

时序数据从时间维度上将孤立的观测值连成一条线，从而揭示软硬件系统等主体的状态变化。孤立的观测值不能叫时序数据，但如果把大量的观测值用时间线串起来，我们就可以研究和分析观测值的趋势及规律。

### 时序数据的特点

`数据模式`：时序数据随时间增长，相同维度重复取值，指标平滑变化。

`写入`： 持续高并发写入，无更新操作。时序数据库面对的往往是百万甚至千万数量级终端设备的实时数据写入，但数据大多表征设备状态，写入后不会更新。

`查询`： 按不同维度对指标进行统计分析，且存在明显的冷热数据，一般只会频繁查询近期数据。

### 时序数据的数学模型

数据的存储要考虑其数学模型和特点，时序数据也不例外。

下图为一段时序数据，记录了一段时间内的某个集群里各机器上各端口的出入流量，每半小时记录一个观测值。这里以图中的数据为例，介绍下时序数据的数学模型（不同的时序数据库中，基本概念的称谓有可能不同，这里以腾讯 CTSDB 为准）：

- `measurement`：度量的数据集，类似于关系型数据库中的 table；

- `point`：一个数据点，类似于关系型数据库中的 row；

- `timestamp`：时间戳，表征采集到数据的时间点；

- `tag`：维度列，代表数据的归属、属性，表明是哪个设备/模块产生的，一般不随着时间变化，供查询使用；
- `field`：指标列，代表数据的测量值，随时间平滑波动，不需要查询。

示例：

![image-20220324163745905](time-series-data-first-meeting/image-20220324163745905.png)



如上图所示，这组数据的 measurement 为 Network，每个 point 由以下部分组成：

- timestamp：时间戳。
- 两个 tag：host 和 port，代表每个 point 归属于哪台机器的哪个端口。

- 两个 filed：bytes_in 和 bytes_out，代表每个 piont 的测量值，即半小时内出入流量的平均值。

### 时序数据的存储

#### 时序数据的存储难点

时序数据往往由百万级甚至千万级终端设备产生的，写入并发量比较高，属于海量数据场景。传统关系型数据库在时序数据的存储和分析上存在不足和缺陷，主要体现在`写入`、`查询`和`存储`三个方面。

时序数据库针对时序数据的特点，对写入、查询和存储等流程进行了优化：

- `高并发写入`
  - 批量写入数据，降低网络开销；
  - 数据先写入内存，再周期性的 dump 为不可变的文件存储。
- `查询低延时、高并发`
  - 优化常见的查询模式，通过索引等技术降低查询延时；
  - 通过缓存、routing 等技术提高查询并发。
- `存储成本`
  - 利用时间递增、维度重复、指标平滑变化的特性，合理选择编码压缩算法，提高数据压缩比；
  - 通过预降精度，对历史数据做聚合，节省存储空间。

#### 时序数据的存储原理

##### 磁盘的分类

`磁盘（disk）`：指利用磁记录技术存储数据的存储器。磁盘是计算机主要的存储介质，可以存储大量的二进制数据，并且断电后也能保持数据不丢失。早期计算机使用的磁盘是软磁盘（Floppy Disk，简称软盘），如今常用的磁盘是硬磁盘（Hard disk，简称硬盘）。

从存储数据的介质上来区分，硬盘可分为机械硬盘（Hard Disk Drive, HDD）和固态硬盘（Solid State Disk, SSD），机械硬盘采用`磁性碟片`来存储数据，而固态硬盘常通过`闪存颗粒`来存储数据。

**机械硬盘（HDD）：**

机械硬盘主要由磁盘盘片、磁头、主轴与传动轴等组成，数据就存放在磁盘盘片中，其物理结构如下：

![image-20220324204821536](time-series-data-first-meeting/image-20220324204821536.png)

机械硬盘每个磁盘盘片有上下两个磁头，磁盘盘片在两个磁头中间高速旋转，类似下图：

![image-20220325093249091](time-series-data-first-meeting/image-20220325093249091.png)

也就是说，机械硬盘是上下盘面同时进数据读取的。目前机械硬盘的常见转速是 `7200 r/min`，所以机械硬盘在读取或写入数据时，非常害怕晃动和磕碰。另外，因为机械硬盘的超高转速，如果内部有灰尘，则会造成磁头或盘片的损坏，所以机械硬盘内部是封闭的，如果不是在无尘环境下，则禁止拆开机械硬盘。

机械硬盘的逻辑结构主要分为`磁道`、`扇区`和`柱面`：

![image-20220325093710519](time-series-data-first-meeting/image-20220325093710519.png)

![image-20220325094218971](time-series-data-first-meeting/image-20220325094218971.png)

- `磁道`：每个盘片都在逻辑上有很多的同心圆，最外面的同心圆就是 0 磁道。我们将每个同心圆称作磁道（注意，磁道只是逻辑结构，在盘面上并没有真正的同心圆）。硬盘的磁道密度非常高，通常一面上就有上千个磁道。但是相邻的磁道之间并不是紧挨着的，这是因为磁化单元相隔太近会相互产生影响。

- `扇区`：在磁盘上每个同心圆是磁道，从圆心向外呈放射状地产生分割线（类似折扇的扇骨），将每个磁道等分为若干弧段，每个弧段就是一个扇区。每个扇区的大小一般是固定的，为  512 Byte。扇区也是磁盘的最小存储单位。

- `柱面`：如果硬盘是由多个盘片组成的，每个盘面都被划分为数目相等的磁道，那么所有盘片都会从外向内进行磁道编号，最外侧的就是 0 磁道。具有相同编号的磁道会形成一个圆柱，这个圆柱就被称作磁盘的柱面。

机械硬盘的大小计算公式：`磁头数 x 柱面数 x 扇区数 x 每个扇区的大小`。其中，磁头数（Heads）表示硬盘共有几个磁头，也可以理解为硬盘有几个盘面，然后乘以 2（每个盘面有上下两个磁头）；柱面数（Cylinders）表示硬盘每面盘片有几条磁道；扇区数（Sectors）表示每条磁道上有几个扇区；每个扇区的大小一般是  512 Byte。

机械硬盘通过接口与计算机主板进行连接，硬盘的读取和写入速度与接口有很大关系，如果接口的性能很差，则会影响机械硬盘的性能。目前，常见的机械硬盘接口有以下几种：

- IDE 硬盘接口（Integrated Drive Eectronics，并口，即电子集成驱动器），也称作 "ATA 硬盘" 或 "PATA 硬盘"，是早期机械硬盘的主要接口，ATA133 硬盘的理论速度可以达到 133 MB/s（此速度为理论平均值）。

  ![image-20220325100042457](time-series-data-first-meeting/image-20220325100042457.png)

- SATA 接口（Serial ATA，串口），是速度更高的硬盘标准，具备了更高的传输速度，并具备了更强的纠错能力。目前已经是 SATA 三代，理论传输速度达到 600 MB/s（此速度为理论平均值）。

  ![image-20220325100234535](time-series-data-first-meeting/image-20220325100234535.png)

- SCSI 接口（Small Computer System Interface，小型计算机系统接口），广泛应用在服务器上，具有应用范围广、多任务、带宽大、CPU 占用率低及热插拔等优点，理论传输速度达到 320 MB/s（此速度为理论平均值）。

  ![image-20220325100622836](time-series-data-first-meeting/image-20220325100622836.png)

**固态硬盘（SSD）：**

固态硬盘和传统的机械硬盘最大的区别就是不再采用盘片进行数据存储，而是采用`存储芯片`进行数据存储。固态硬盘的存储芯片主要分为两种：一种是采用`闪存`作为存储介质的；另一种是采用 `DRAM` 作为存储介质的。目前使用较多的主要是采用闪存作为存储介质的固态硬盘。

![image-20220325101457388](time-series-data-first-meeting/image-20220325101457388.png)

固态硬盘和机械硬盘对比，主要有以下一些特点：

| 对比项目  | 固态硬盘          | 机械硬盘 |
| --------- | ----------------- | -------- |
| 容量      | 较小              | 大       |
| 读/写速度 | 极快              | —般      |
| 写入次数  | 5000 〜 100000 次 | 没有限制 |
| 工作噪声  | 极低              | 有       |
| 工作温度  | 极低              | 较高     |
| 防震      | 很好              | 怕震动   |
| 重量      | 低                | 高       |
| 价格      | 高                | 低       |

可以看到，固态硬盘因为丟弃了机械硬盘的物理结构，所以相比机械硬盘，具有低能耗、无噪声、抗震动、低散热、体积小和速度快的优势，不过价格相比机械硬盘更高，而且使用寿命有限。

##### 磁盘的随机读写和顺序读写



## 时序数据库









